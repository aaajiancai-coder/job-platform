<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.job.mapper.ApplicationMapper">

    <select id="countByJobIds" resultType="int" parameterType="java.util.List">
        SELECT COUNT(*) FROM applications
        WHERE job_id IN
        <foreach collection="jobIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="countByJobIdsAndStatus" resultType="int" parameterType="map">
        SELECT COUNT(*) FROM applications
        WHERE job_id IN
        <foreach collection="jobIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND status = #{status}
    </select>

    <!-- ApplicationMapper.xml 示例 -->
    <select id="selectByStudentId" resultType="com.job.entity.Application">
        SELECT * FROM applications WHERE student_id = #{studentId}
    </select>

    <select id="countByStudentId" resultType="int">
        SELECT COUNT(*) FROM applications WHERE student_id = #{studentId}
    </select>

    <select id="countByStudentIdAndStatus" resultType="int">
        SELECT COUNT(*) FROM applications WHERE student_id = #{studentId} AND status = #{status}
    </select>

    <update id="withdrawById">
        UPDATE applications SET status = '已撤回' WHERE id = #{applicationId}
    </update>

    <select id="selectWithJobAndCompanyByStudentId" resultType="com.job.dto.ApplicationWithJobCompanyDTO">
        SELECT
            a.id,
            a.job_id AS jobId,
            j.title AS jobTitle,
            c.company_name AS companyName,
            a.resume_id AS resumeId,
            a.status,
            a.apply_time AS applyTime,
            a.updated_at AS updatedAt
        FROM applications a
        LEFT JOIN jobs j ON a.job_id = j.id
        LEFT JOIN company_profiles c ON j.company_id = c.id
        WHERE a.student_id = #{studentId}
        ORDER BY a.apply_time DESC
    </select>

    <select id="selectWithJobAndCompanyByStudentIdPaged" resultType="com.job.dto.ApplicationWithJobCompanyDTO">
        SELECT
            a.id,
            a.job_id AS jobId,
            j.title AS jobTitle,
            c.company_name AS companyName,
            a.resume_id AS resumeId,
            a.status,
            a.apply_time AS applyTime,
            a.updated_at AS updatedAt
        FROM applications a
        LEFT JOIN jobs j ON a.job_id = j.id
        LEFT JOIN company_profiles c ON j.company_id = c.id
        WHERE a.student_id = #{studentId}
        ORDER BY a.apply_time DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <select id="selectCompanyResumes" resultType="com.job.dto.ApplicationWithJobCompanyDTO">
        SELECT
            a.id,
            a.job_id AS jobId,
            j.title AS jobTitle,
            c.company_name AS companyName,
            a.resume_id AS resumeId,
            a.status,
            a.apply_time AS applyTime,
            a.updated_at AS updatedAt,
            s.real_name AS studentName
        FROM applications a
        LEFT JOIN jobs j ON a.job_id = j.id
        LEFT JOIN company_profiles c ON j.company_id = c.id
        LEFT JOIN student_profiles s ON a.student_id = s.id
        WHERE j.company_id = #{companyId}
        <if test="jobId != null and jobId != ''">
            AND a.job_id = #{jobId}
        </if>
        <if test="status != null and status != ''">
            AND a.status = #{status}
        </if>
        ORDER BY a.apply_time DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <select id="countCompanyResumes" resultType="int">
        SELECT COUNT(*)
        FROM applications a
        LEFT JOIN jobs j ON a.job_id = j.id
        WHERE j.company_id = #{companyId}
        <if test="jobId != null and jobId != ''">
            AND a.job_id = #{jobId}
        </if>
        <if test="status != null and status != ''">
            AND a.status = #{status}
        </if>
    </select>

    <update id="updateResumeStatus">
        UPDATE applications
        SET status = #{status}
        WHERE id = #{applicationId}
    </update>

    <select id="selectApplicationDetail" resultType="com.job.dto.ApplicationDetailDTO">
        SELECT
            a.id AS application_id, a.*, 
            s.id AS student_id, s.*, 
            r.id AS resume_id, r.*
        FROM applications a
        LEFT JOIN student_profiles s ON a.student_id = s.id
        LEFT JOIN resumes r ON a.resume_id = r.id
        WHERE a.id = #{applicationId}
    </select>

    <select id="countByDate" resultType="int">
        SELECT COUNT(*) FROM applications WHERE DATE(apply_time) = #{date}
    </select>

</mapper>